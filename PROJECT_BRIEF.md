
# 项目简介：流媒体用量与预算管理平台

## 一、项目概述 (Elevator Pitch)

这是一个专为流媒体爱好者打造的全栈式 **用量追踪与预算管理平台**。

在当今流媒体服务日益增多的时代，用户往往订阅了多个平台（如腾讯视频、哔哩哔哩、网易云音乐等），但却难以统一管理和追踪在这些服务上的花费和使用情况。本项目旨在解决这一痛点，通过一个统一的仪表盘，帮助用户 **集成和监控** 他们在各个流媒体服务上的活动，**可视化分析** 消费习惯，并提供 **智能预算告警**，从而实现更精细化的数字消费管理。

项目的核心价值在于 **数据整合** 和 **智能分析**，它不仅仅是一个记账工具，更是一个帮助用户优化其流媒体订阅策略的个人助手。

## 二、核心功能模块

根据代码结构和数据模型，项目主要包含以下几个核心功能：

1.  **统一用户认证系统 (Authentication)**
    *   **实现方式**: 基于 `NextAuth.js`，提供了一套完整的用户认证解决方案。
    *   **功能亮点**:
        *   支持 **邮箱/密码** 的传统注册登录方式。
        *   集成了 **OAuth 第三方登录**（例如 Google, GitHub 等），简化了用户的注册流程。
        *   通过 `Prisma Adapter`，将用户信息和会话无缝持久化到 MySQL 数据库中。

2.  **流媒体账户管理 (Streaming Account Management)**
    *   **实现方式**: 用户可以添加和管理他们在不同流媒体平台（如 `腾讯视频`, `哔哩哔哩` 等，通过 `enum StreamingService` 定义）的账户信息。
    *   **功能亮点**:
        *   记录了每个账户的订阅费用、币种、账单日等关键财务信息。
        *   预留了 `apiKey` 等字段，为未来通过 API 自动拉取用量数据提供了扩展性。

3.  **用量监控与数据可视化仪表盘 (Monitoring Dashboard)**
    *   **实现方式**: 这是项目的核心展示模块，位于 `/src/app/monitoring`。
    *   **技术栈**: 使用 `ECharts` 和 `@tanstack/react-query` 构建。
    *   **功能亮点**:
        *   **多维度数据展示**: 提供带宽、存储、转码、推流等多个维度的监控视图。
        *   **实时数据更新**: 利用 `react-query` 管理数据获取和缓存，确保了仪表盘数据的准实时性。
        *   **交互式图表**: 用户可以通过图表进行下钻、筛选和排序，深入分析自己的使用模式。
        *   **混合数据源**: 后端集成了 `InfluxDB`（一个时间序列数据库），专门用于存储和查询大量的监控数据，这在处理高频用量记录时性能远超传统关系型数据库。

4.  **智能预算与告警系统 (Budget & Notification System)**
    *   **实现方式**: 用户可以根据自己的消费能力，设置月度或年度预算。
    *   **功能亮点**:
        *   **灵活的预算设置**: 可以为全部服务或特定几个服务设置总预算。
        *   **自动告警**: 当消费达到预算的 50%、80%、100% 时，系统会自动触发告警。
        *   **多渠道通知**: 结合 `Notification` 模型，未来可以轻松扩展到邮件、App 推送等多种通知方式。

5.  **直播流管理 (Live Stream Management)**
    *   **实现方式**: `LiveStream` 模型允许用户管理直播流信息。
    *   **功能亮点**: 这是一个相对独立但有价值的功能，可以记录直播推流的域名、区域、分辨率、码率等技术参数，并追踪其状态。这展示了项目向更专业流媒体领域扩展的潜力。

6.  **用户个性化配置 (User Preferences)**
    *   **功能亮点**: 用户可以自定义通知开关、默认货币、时区、日期格式等，提升了产品的用户体验和国际化能力。

## 三、技术架构 (Technical Architecture)

这是一个基于 **Next.js App Router** 的现代全栈 TypeScript 项目。

*   **前端 (Frontend)**:
    *   **框架**: `Next.js 15` (React 19)
    *   **语言**: `TypeScript`
    *   **UI 库**: `Ant Design` 结合 `Tailwind CSS`，兼顾了快速开发和自定义样式的灵活性。
    *   **状态管理**: `Zustand`，一个轻量级、上手快的状态管理库。
    *   **表单处理**: `React Hook Form` 结合 `Zod` 进行表单验证，保证了数据输入的健壮性。
    *   **数据可视化**: `ECharts`，强大的图表库，用于构建监控仪表盘。
    *   **数据请求**: `@tanstack/react-query`，用于服务端数据获取、缓存和同步。

*   **后端 (Backend)**:
    *   **框架**: `Next.js API Routes`
    *   **ORM**: `Prisma`，提供了类型安全的方式来操作数据库。
    *   **认证**: `NextAuth.js`

*   **数据库 (Database)**:
    *   **关系型数据库**: `MySQL`，用于存储用户、账户、预算等核心业务数据 (由 `schema.prisma` 定义)。
    *   **时间序列数据库**: `InfluxDB`，用于存储高频的用量和监控数据，是架构的一大亮点。
    *   **键值数据库**: `Redis`，用于缓存和会话管理 (`ioredis` 依赖)。

*   **开发与部署 (DevOps)**:
    *   **代码质量**: 使用 `ESLint` 和 `Prettier` 保证代码风格和质量统一。
    *   **部署**: 提供了 `Railway` 的一键构建和初始化脚本 (`railway-build.sh`, `railway-init.sh`)，展示了对 CI/CD 流程的熟悉。

## 四、项目亮点与可深入讨论的点 (Talking Points)

1.  **混合数据存储架构**:
    *   “在本项目中，我没有将所有数据都存放在 MySQL 中。考虑到监控数据具有明显的时间序列特性（高频写入、按时间范围查询），我特意引入了 InfluxDB。这不仅优化了查询性能，也降低了主业务数据库的负载，体现了我在数据库选型上的考量。”

2.  **类型安全的全栈开发体验**:
    *   “整个项目从前端到后端，再到数据库层面（通过 Prisma），都实现了端到端的类型安全。这极大地减少了运行时错误，提高了开发效率和代码的可维护性。”

3.  **高性能的监控仪表盘设计**:
    *   “监控页面的性能至关重要。我使用了 `@tanstack/react-query` 来管理复杂的数据请求逻辑，它提供的缓存、后台刷新、请求去重等功能，确保了仪表盘在数据量大时依然能流畅响应。同时，后端使用 InfluxDB 保证了查询效率。”

4.  **可扩展的认证与集成设计**:
    *   “认证系统基于 NextAuth，非常易于扩展新的 OAuth 提供商。同时，在设计流媒体账户模型时，我预留了 API Key 等字段，为将来直接对接各大平台的官方 API、实现数据自动同步打下了基础。”

5.  **对现代前端生态的熟练掌握**:
    *   可以谈论为什么选择 `Next.js App Router`, `Zustand`, `React Hook Form`, `Tailwind CSS` 等工具，以及它们分别解决了什么问题。

## 五、未来展望 (Potential Improvements)

*   **更深入的智能分析**: 基于用量数据，利用机器学习预测用户下个月的消费，并给出订阅优化建议。
*   **实时通知系统**: 使用 `WebSockets` 替代轮询，实现预算超支的实时告警。
*   **移动端应用**: 使用 `React Native` 或原生开发，提供跨平台的移动体验。
*   **自动化数据导入**: 开发浏览器插件或利用开放 API，实现自动导入用户在流媒体网站的观看历史。

## 六、项目挑战与优化 (Challenges & Optimizations)

1.  **前端状态管理复杂性**
    *   **问题**: 在 `MonitoringClient.tsx` 组件中，随着筛选条件和图表类型的增多，使用了大量的 `useState` 和 `useEffect` 来管理状态。这导致状态逻辑分散，数据流变得复杂，难以追踪和维护。例如，多个 `useEffect` 分别处理不同的数据加载逻辑，增加了理解成本。
    *   **优化方案**:
        *   **轻度重构**: 引入 `useReducer` 将相关的状态（如所有筛选条件 `filters`）和更新逻辑聚合起来，使状态变更更加可预测。
        *   **深度重构**: 将核心状态（如筛选条件、图表数据、UI 状态）提升到 `Zustand` store 中进行统一管理。这样做的好处是：1) 将状态逻辑从组件中完全分离，使组件更专注于 UI 渲染；2) 多个子组件可以按需订阅 `Zustand` store 中的数据，避免了不必要的 props drilling（属性逐层传递）。

2.  **API 路由中的重复逻辑**
    *   **问题**: 在 `src/app/api/` 目录下的多个路由文件（如 `streams`, `accounts` 等）中，存在大量重复的代码逻辑，尤其是 `GET`, `PUT`, `DELETE` 等 handler 的开头部分，都需要进行 session 校验和错误处理。
    *   **优化方案**:
        *   **创建高阶函数 (Higher-Order Function, HOF)**: 编写一个 `withAuth` 或 `withApiAuth` 的高阶函数，它接收一个 API handler 作为参数。在这个高阶函数内部，统一处理 session 校验、参数解析和全局的 `try-catch` 错误处理。这样，每个具体的 API handler 只需关注其核心的业务逻辑。

        ```typescript
        // 示例：
        // export async function GET(req, { params }) { ... }
        // 优化为 ->
        // export const GET = withApiAuth(async (req, { params, session }) => {
        //   // 此处直接使用 session 对象，无需再手动获取
        // });
        ```

3.  **中间件（Middleware）授权策略的健壮性**
    *   **问题**: 在 `src/middleware.ts` 中，`authorized` 回调函数为了处理“刚刚登录”的场景，使用了 `referer` 请求头来判断来源。这种方式存在一定风险，因为 `referer` 可以被客户端伪造或禁用，不是一个完全可靠的安全凭证。
    *   **优化方案**:
        *   **简化并强化授权逻辑**: 移除对 `referer` 的依赖。`withAuth` 中间件本身的设计已经足够处理重定向逻辑。可以简化 `authorized` 回调的逻辑：对于所有非公开路由，**唯一且充分**的条件就是 `!!token`。如果 token 不存在，中间件会自动将用户重定向到 `signIn` 页面。这种方式更安全、更简洁，也更符合 `NextAuth` 的最佳实践。 